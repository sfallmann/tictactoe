<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="src/css/styles.css">
  </head>


  <body>
    <div class="container">
      <div class="row">
        <div class="col-4"></div>
        <div class="col-4 no-padding">
          <div class="wrapper">
            <img id="grid-svg" src="assets/img/grid.svg">
            <table id="grid" class='clickable' class='clickable'>
              <tr></tr>
              <tr></tr>
              <tr></tr>
            </table>              
          </div>       
          
        </div>
        <div class="col-4">
  
        </div>
      </div>
    </div>

    <br>
    First Name<input name='firstname' type='text'>
    <br>
    <input type="radio" name="token" value="O"> O
    <br>
    <input type="radio" name="token" value="X"> X
    <br>
    <input id="start" type="button" value="start" onclick=start()>
    <br>
    <br>

    <div id="messages"></div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/1.19.1/TweenMax.min.js"></script>
    <script src="https://cdn.jsdelivr.net/lodash/4.17.4/lodash.min.js"></script>
    <script src="src/js/tic-tac-toe.js"></script>
    <script>

      var ui = {
        O: 'assets/img/o-ttt.svg',
        X: 'assets/img/x-ttt.svg',
        gamegrid: document.querySelector('#grid'),
        init: function init(player1, player2) {
          this.game = TicTacToe(player1, player2);          
          this.gamegrid.addEventListener("click", this.clickedSquare.bind(this));
          this.drawBoard();
          var player = this.game.players[0];
          this.displayMessage(player.name + '\'s turn');
          if (player.type === 'computer'){
            setTimeout(this.computersTurn.bind(this), 1500);
          }
        },
        drawBoard: function drawBoard(board) {
          var rows = document.getElementsByTagName('tr');
          var td;
          for (var i = 3 - 1; i >= 0; i--) {
            for (var j = 0; j < 3; j++) {
              td = document.createElement('td');
              td.dataset.x = j;
              td.dataset.y = i;
              rows[2-i].appendChild(td);
            } 
          }
        },
        displayMessage: function(msg) {
          var messages = document.querySelector('#messages');
          messages.innerHTML = msg;
        },
        placeToken: function placeToken(target, token){
          tokenImg = document.createElement ('object');
          tokenImg.data = this[token];
          tokenImg.type = 'image/svg+xml';
          tokenImg.classList.add('token');
          target.appendChild(tokenImg);
          //TweenLite.to(tokenImg, 2, {color:"red"});
        },
        clickedSquare: function clickedSquare(e) {
          if (!this.gamegrid.classList.contains('clickable') || !this.isSquareEmpty(e.target)){
            return;
          }
          var player = this.game.players[0];
          var status = checkForWin(this.game.board, this.game.counter);
          if (status === CONTINUE && player.type === 'human'){
            var target = e.target;
            var x = target.dataset.x;
            var y = target.dataset.y;
            var token = player.token;
            this.game.turn(x, y);
            this.placeToken(target, token);
            this.turnComplete();
          }
        },  
        computersTurn: function computersTurn() {
          this.gamegrid.classList.toggle('clickable');
          var player = this.game.players[0];
          var token = player.token;
          var tile = this.game.turn();  
          var x = '[data-x="' + tile.x + '"]';
          var y = '[data-y="' + tile.y + '"]';
          var target = document.querySelector(x+y);
          this.placeToken(target, token);
          this.gamegrid.classList.toggle('clickable');
          this.turnComplete();       
        },
        turnComplete: function turnComplete() {
          var status = checkForWin(this.game.board, this.game.counter);

          if (status !== CONTINUE){
            this.gamegrid.removeEventListener("click", this.clickedSquare);
            if(status !== DRAW){
              var player = (this.game.players.filter(function(player){
                return player.token == status;
              }))[0];
              this.displayMessage(player.name + ' has won the game!!!');
            } else {
              this.displayMessage(status);
            }    
            return;
          }
          var player = this.game.players[0];
          this.displayMessage(player.name + '\'s turn');
          if (player.type === 'computer') {
            setTimeout(this.computersTurn.bind(this), 1500);
          }
        },
        isSquareEmpty: function isSquareEmpty(target){
          return target.innerHTML === '' ? true : false;
        }        
      };
      function start(){
        var name = document.querySelector('[name=firstname]').value;
        var token = document.querySelector('[name=token]:checked').value;

        var player1, player2;
        console.log(token)
        if (token === 'O'){
          player1 = {
            name: 'Sean',
            token: 'O',
            type: 'human'
          };
          player2 = {
            name: 'Computer',
            token: 'X',
            type: 'computer'
          };
        } else {
          player1 = {
            name: 'Computer',
            token: 'O',
            type: 'computer'
          };  
          player2 = {
            name: 'Sean',
            token: 'X',
            type: 'human'
          };     
        }
        
        ui.init(player1, player2);  
      }

    </script>
  </body>
</html>